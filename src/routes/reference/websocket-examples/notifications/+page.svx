<script>
  import ReferenceLayout from '$lib/components/common/ReferenceLayout.svelte';
  import Mermaid from '$lib/components/Mermaid.svelte';
  import UseCaseExample from '$lib/components/UseCaseExample.svelte';
  import Card from '$lib/components/common/Card.svelte';
  import Section from '$lib/components/common/Section.svelte';
  import { notificationFlowDiagram, alertEscalationDiagram } from '$lib/charts/allCharts.ts';
  
  const preferencesCode = `// é€šçŸ¥è¨­å®šç®¡ç†
class NotificationPreferences {
  constructor(userId) {
    this.userId = userId;
    this.preferences = this.loadPreferences();
  }
  
  shouldSendNotification(notificationType, timeZone) {
    const pref = this.preferences[notificationType];
    if (!pref.enabled) return false;
    
    const currentTime = new Date().toLocaleString("en-US", {timeZone});
    const hour = new Date(currentTime).getHours();
    
    // ä¼‘çœ æ™‚é–“ã®ç¢ºèª
    if (pref.quietHours && pref.quietHours.enabled) {
      const { start, end } = pref.quietHours;
      if (start <= end) {
        // é€šå¸¸ã®æ™‚é–“å¸¯ (e.g., 22:00-07:00)
        if (hour >= start || hour < end) return false;
      } else {
        // æ—¥ã‚’ã¾ãŸãæ™‚é–“å¸¯ (e.g., 22:00-07:00)
        if (hour >= start && hour < end) return false;
      }
    }
    
    // ãƒ•ãƒªãƒ¼ã‚¯ã‚¨ãƒ³ã‚·ãƒ¼åˆ¶é™
    if (pref.frequency) {
      const recentCount = this.getRecentNotificationCount(notificationType);
      if (recentCount >= pref.frequency.maxPerHour) return false;
    }
    
    return true;
  }
  
  updatePreference(type, settings) {
    this.preferences[type] = { ...this.preferences[type], ...settings };
    this.savePreferences();
    
    // WebSocketã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
    this.websocket.send(JSON.stringify({
      type: 'preference_update',
      preferences: this.preferences
    }));
  }
  
  getChannelPreferences(notificationType) {
    const pref = this.preferences[notificationType];
    return {
      email: pref.channels?.email ?? true,
      push: pref.channels?.push ?? true,
      inApp: pref.channels?.inApp ?? true,
      sms: pref.channels?.sms ?? false
    };
  }
}`;

  const rateLimiterCode = `// é€šçŸ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
class NotificationRateLimiter {
  constructor() {
    this.userLimits = new Map(); // userId -> { count, resetTime }
    this.globalLimit = { maxPerMinute: 1000, current: 0 };
    this.channelLimits = {
      email: { maxPerHour: 20 },
      push: { maxPerMinute: 30 },
      sms: { maxPerDay: 10 }
    };
  }
  
  async canSendNotification(userId, notificationType, channel) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥åˆ¶é™ãƒã‚§ãƒƒã‚¯
    const userLimit = this.getUserLimit(userId);
    if (userLimit.count >= this.getLimitForType(notificationType)) {
      await this.logRateLimitExceeded(userId, 'user_limit');
      return false;
    }
    
    // ãƒãƒ£ãƒãƒ«åˆ¥åˆ¶é™ãƒã‚§ãƒƒã‚¯
    const channelUsage = await this.getChannelUsage(userId, channel);
    const channelLimit = this.channelLimits[channel];
    if (channelUsage.count >= channelLimit.maxPerHour) {
      await this.logRateLimitExceeded(userId, 'channel_limit', channel);
      return false;
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (this.globalLimit.current >= this.globalLimit.maxPerMinute) {
      await this.logRateLimitExceeded(userId, 'global_limit');
      return false;
    }
    
    return true;
  }
  
  recordNotification(userId, channel) {
    this.incrementUserCount(userId);
    this.incrementChannelCount(userId, channel);
    this.globalLimit.current++;
    
    // WebSocketã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™æƒ…å ±ã‚’é…ä¿¡
    this.broadcastRateLimitStatus();
  }
  
  getUserLimit(userId) {
    if (!this.userLimits.has(userId)) {
      this.userLimits.set(userId, {
        count: 0,
        resetTime: Date.now() + 3600000 // 1æ™‚é–“å¾Œ
      });
    }
    
    const limit = this.userLimits.get(userId);
    
    // ãƒªã‚»ãƒƒãƒˆæ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    if (Date.now() > limit.resetTime) {
      limit.count = 0;
      limit.resetTime = Date.now() + 3600000;
    }
    
    return limit;
  }
}`;

  const deliveryCode = `// é«˜ä¿¡é ¼æ€§é€šçŸ¥é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ 
class ReliableNotificationDelivery {
  constructor() {
    this.pendingNotifications = new Map();
    this.retryDelays = [1000, 5000, 15000, 60000]; // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
    this.deliveryQueue = new PriorityQueue();
  }
  
  async sendWithRetry(notification, maxRetries = 3) {
    const deliveryId = generateId();
    
    // é…ä¿¡è¨˜éŒ²ã®é–‹å§‹
    await this.startDeliveryTracking(deliveryId, notification);
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        // ãƒãƒ£ãƒãƒ«åˆ¥é…ä¿¡
        const result = await this.sendByChannel(notification);
        
        // é…ä¿¡æˆåŠŸã‚’è¨˜éŒ²
        await this.recordDeliverySuccess(deliveryId, result);
        
        // WebSocketã§é…ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        this.broadcastDeliveryStatus({
          notificationId: notification.id,
          status: 'delivered',
          timestamp: Date.now()
        });
        
        return { success: true, attempts: attempt + 1, result };
        
      } catch (error) {
        console.error('Delivery attempt ' + (attempt + 1) + ' failed:', error);
        
        if (attempt === maxRetries) {
          await this.handleFailedDelivery(deliveryId, notification, error);
          throw new Error('Failed after ' + (maxRetries + 1) + ' attempts: ' + error.message);
        }
        
        // ãƒªãƒˆãƒ©ã‚¤é–“éš”ã‚’è¨ˆç®—
        const delay = this.calculateRetryDelay(attempt);
        await this.sleep(delay);
      }
    }
  }
  
  async sendByChannel(notification) {
    const channels = notification.channels || ['push', 'inApp'];
    const results = [];
    
    for (const channel of channels) {
      try {
        switch (channel) {
          case 'push':
            results.push(await this.sendPushNotification(notification));
            break;
          case 'email':
            results.push(await this.sendEmailNotification(notification));
            break;
          case 'sms':
            results.push(await this.sendSMSNotification(notification));
            break;
          case 'inApp':
            results.push(await this.sendInAppNotification(notification));
            break;
          case 'websocket':
            results.push(await this.sendWebSocketNotification(notification));
            break;
        }
      } catch (error) {
        console.error('Failed to send via ' + channel + ':', error);
        results.push({ channel, success: false, error: error.message });
      }
    }
    
    return results;
  }
  
  async sendWebSocketNotification(notification) {
    const connections = await this.getUserConnections(notification.userId);
    
    if (connections.length === 0) {
      return { channel: 'websocket', success: false, reason: 'No active connections' };
    }
    
    let successCount = 0;
    
    for (const connection of connections) {
      try {
        await connection.send(JSON.stringify({
          type: 'notification',
          data: notification
        }));
        successCount++;
      } catch (error) {
        console.error('Failed to send to connection ' + connection.id + ':', error);
      }
    }
    
    return {
      channel: 'websocket',
      success: successCount > 0,
      deliveredTo: successCount,
      totalConnections: connections.length
    };
  }
  
  handleFailedDelivery(deliveryId, notification, error) {
    // Dead Letter Queue ã¸ã®ç§»å‹•
    this.moveToDeadLetterQueue(notification, error);
    
    // ç®¡ç†è€…ã¸ã®é€šçŸ¥
    this.notifyAdministrators({
      type: 'delivery_failure',
      notification,
      error: error.message,
      timestamp: Date.now()
    });
    
    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ›´æ–°
    this.metrics.recordFailure(notification.type, error);
  }
}`;

  const metricsCode = `// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹
class NotificationMetrics {
  constructor() {
    this.metrics = {
      sent: 0,
      delivered: 0,
      opened: 0,
      clicked: 0,
      failed: 0,
      channels: {
        push: { sent: 0, delivered: 0, failed: 0 },
        email: { sent: 0, delivered: 0, failed: 0 },
        sms: { sent: 0, delivered: 0, failed: 0 },
        websocket: { sent: 0, delivered: 0, failed: 0 }
      }
    };
    this.setupRealTimeReporting();
  }
  
  setupRealTimeReporting() {
    // 5ç§’ã”ã¨ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é…ä¿¡
    setInterval(() => {
      this.sendMetricsUpdate();
    }, 5000);
    
    // WebSocketæ¥ç¶šç›£è¦–
    this.websocket.on('connection', (ws) => {
      ws.on('message', (data) => {
        const message = JSON.parse(data);
        if (message.type === 'metrics_subscribe') {
          this.addMetricsSubscriber(ws);
        }
      });
    });
  }
  
  recordEvent(eventType, metadata = {}) {
    this.metrics[eventType]++;
    
    // ãƒãƒ£ãƒãƒ«åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    if (metadata.channel) {
      this.metrics.channels[metadata.channel][eventType]++;
    }
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é€ä¿¡
    this.broadcastMetricUpdate({
      type: eventType,
      count: this.metrics[eventType],
      channel: metadata.channel,
      timestamp: Date.now(),
      metadata
    });
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
    this.checkAlertThresholds(eventType);
  }
  
  async generateReport(timeRange) {
    const report = {
      timeRange,
      summary: {
        totalSent: this.metrics.sent,
        deliveryRate: (this.metrics.delivered / this.metrics.sent * 100).toFixed(2) + '%',
        openRate: (this.metrics.opened / this.metrics.delivered * 100).toFixed(2) + '%',
        clickRate: (this.metrics.clicked / this.metrics.opened * 100).toFixed(2) + '%',
        failureRate: (this.metrics.failed / this.metrics.sent * 100).toFixed(2) + '%'
      },
      channelPerformance: this.calculateChannelPerformance(),
      trends: await this.calculateTrends(timeRange),
      recommendations: this.generateRecommendations()
    };
    
    return report;
  }
  
  checkAlertThresholds(eventType) {
    const thresholds = {
      failureRate: 0.05, // 5%ä»¥ä¸Šã®å¤±æ•—ç‡
      deliveryDelay: 30000 // 30ç§’ä»¥ä¸Šã®é…å»¶
    };
    
    const currentFailureRate = this.metrics.failed / this.metrics.sent;
    
    if (currentFailureRate > thresholds.failureRate) {
      this.triggerAlert({
        type: 'high_failure_rate',
        currentRate: currentFailureRate,
        threshold: thresholds.failureRate,
        severity: 'critical'
      });
    }
  }
}`;
</script>

<ReferenceLayout
  description="ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã€ã‚¢ãƒ©ãƒ¼ãƒˆé…ä¿¡ã€ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é€šçŸ¥ã®WebSocketã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"
  referenceCategory="é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ " 
  title="é€šçŸ¥ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ è©³ç´°"
  duration="90-120åˆ†"
  difficulty="ä¸­ç´š"
  prerequisites={["WebSocketã®åŸºæœ¬æ¦‚å¿µ", "é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®ç†è§£", "ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥", "ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"]}
  sectionTitle="ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹"
  learningObjectives={["ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ", "ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€£æº", "ã‚¢ãƒ©ãƒ¼ãƒˆå„ªå…ˆåº¦ç®¡ç†", "ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é…ä¿¡", "é€šçŸ¥ã®æœ€é©åŒ–"]}
>

<Section title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ " icon="concept">

<Card title="ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é€šçŸ¥ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£" icon="info" accentColor="blue">

ç¾ä»£ã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¯ã€è¤‡æ•°ã®é…ä¿¡ãƒãƒ£ãƒãƒ«ã‚’çµ±åˆçš„ã«ç®¡ç†ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¾ã™ã€‚

- **ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼**: æ§˜ã€…ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†
- **ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³**: é©åˆ‡ãªå—ä¿¡è€…ã‚’ç‰¹å®š
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ**: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆ
- **é…ä¿¡ãƒ«ãƒ¼ã‚¿ãƒ¼**: æœ€é©ãªãƒãƒ£ãƒãƒ«ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- **é…ä¿¡çµ±è¨ˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®é…ä¿¡çŠ¶æ³ç›£è¦–

</Card>

<Mermaid chart={`
graph TB
    subgraph "ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹"
        A[ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³] --> E[ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼]
        B[â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯] --> E
        C[ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ] --> E
        D[ğŸ”§ APIå‘¼ã³å‡ºã—] --> E
    end
    
    subgraph "é€šçŸ¥ã‚¨ãƒ³ã‚¸ãƒ³"
        E --> F[ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°]
        F --> G[ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ]
        G --> H[ğŸ”„ é…ä¿¡ãƒ«ãƒ¼ã‚¿ãƒ¼]
    end
    
    subgraph "é…ä¿¡ãƒãƒ£ãƒãƒ«"
        H -->|WebSocket| I[ğŸ’» Webãƒ–ãƒ©ã‚¦ã‚¶]
        H -->|WebSocket| J[ğŸ“± PWAã‚¢ãƒ—ãƒª]
        H -->|Push API| K[ğŸ“² ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª]
        H -->|WebSocket| L[ğŸ–¥ï¸ ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—]
        H -->|Email| M[ğŸ“§ ãƒ¡ãƒ¼ãƒ«]
        H -->|SMS| N[ğŸ“± SMS]
    end
    
    subgraph "ç®¡ç†æ©Ÿèƒ½"
        O[âš™ï¸ è¨­å®šç®¡ç†] --> F
        P[ğŸ“Š é…ä¿¡çµ±è¨ˆ] --> H
        Q[ğŸ’¾ é€šçŸ¥å±¥æ­´] --> G
    end
    
    style E fill:#f3e5f5
    style F fill:#e8f5e8
    style H fill:#fff3e0
    style I fill:#e3f2fd
    style J fill:#e1f5fe
`} />

<Card title="é€šçŸ¥ãƒ•ãƒ­ãƒ¼è©³ç´°" icon="info" accentColor="green">

é€šçŸ¥ã®é…ä¿¡ãƒ•ãƒ­ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã«å¿œã˜ãŸå‡¦ç†ã€‚

</Card>

<Mermaid chart={notificationFlowDiagram} />

</Section>

<Section title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ç®¡ç†" icon="concept">

<Card title="é€šçŸ¥è¨­å®šã‚·ã‚¹ãƒ†ãƒ " icon="info" accentColor="purple">

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­å¿ƒã®é€šçŸ¥è¨­å®šç®¡ç†ã§ã€æœ€é©ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚

</Card>

<Mermaid chart={`
graph LR
    subgraph "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š"
        U[ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼] --> S[âš™ï¸ è¨­å®šUI]
        S --> P1[ğŸ”” é€šçŸ¥ç¨®åˆ¥è¨­å®š]
        S --> P2[â° æ™‚é–“å¸¯è¨­å®š]
        S --> P3[ğŸ“± ãƒ‡ãƒã‚¤ã‚¹è¨­å®š]
        S --> P4[ğŸ¯ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š]
    end
    
    subgraph "è¨­å®šç®¡ç†"
        P1 --> DB[ğŸ’¾ è¨­å®šDB]
        P2 --> DB
        P3 --> DB
        P4 --> DB
        
        DB --> C[âš¡ è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥]
    end
    
    subgraph "é…ä¿¡åˆ¶å¾¡"
        C --> F[ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°]
        F --> R[ğŸ“Š ãƒ¬ãƒ¼ãƒˆåˆ¶é™]
        R --> Q[â³ ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°]
        Q --> D[ğŸ“¤ é…ä¿¡å®Ÿè¡Œ]
    end
    
    style DB fill:#e8f5e8
    style C fill:#fff3e0
    style F fill:#f3e5f5
    style D fill:#e3f2fd
`} />

</Section>

<Section title="ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ " icon="concept">

<Card title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" icon="info" accentColor="indigo">

WebSocketã‚’æ´»ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹æˆã€‚

</Card>

<Mermaid chart={`
graph TB
    subgraph "ç›£è¦–å¯¾è±¡"
        S1[ğŸ–¥ï¸ Webã‚µãƒ¼ãƒãƒ¼] --> M[ğŸ“Š ç›£è¦–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ]
        S2[ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹] --> M
        S3[ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯] --> M
        S4[ğŸ”§ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³] --> M
    end
    
    subgraph "ã‚¢ãƒ©ãƒ¼ãƒˆå‡¦ç†"
        M --> A[ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³]
        A --> T[ğŸ“ é–¾å€¤åˆ¤å®š]
        T --> E[âš¡ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]
        E --> N[ğŸ”” é€šçŸ¥ç”Ÿæˆ]
    end
    
    subgraph "é…ä¿¡å…ˆ"
        N --> WS[WebSocketã‚µãƒ¼ãƒãƒ¼]
        WS --> D1[ğŸ’» ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰]
        WS --> D2[ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª]
        WS --> D3[ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥]
        WS --> D4[ğŸ“² SMSé€šçŸ¥]
    end
    
    subgraph "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†"
        N --> I[ğŸ“‹ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆä½œæˆ]
        I --> W[ğŸ”„ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼]
        W --> R[ğŸ“ å¯¾å¿œè¨˜éŒ²]
    end
    
    style M fill:#f3e5f5
    style A fill:#fff3e0
    style N fill:#e8f5e8
    style WS fill:#e3f2fd
`} />

<Card title="ã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³" icon="warning" accentColor="orange">

é‡è¦åº¦ã«å¿œã˜ãŸã‚¢ãƒ©ãƒ¼ãƒˆã®è‡ªå‹•ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼ã€‚

</Card>

<Mermaid chart={alertEscalationDiagram} />

</Section>

<Section title="PWAçµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ " icon="concept">

<Card title="Service Workeré€£æº" icon="info" accentColor="pink">

Progressive Web Appã§ã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚

</Card>

<Mermaid chart={`
graph TD
    subgraph "PWAã‚¢ãƒ—ãƒª"
        A[ğŸ“± PWAã‚¢ãƒ—ãƒª] --> SW[ğŸ”„ Service Worker]
        SW --> N[ğŸ”” Notification API]
        SW --> B[ğŸ“‚ Background Sync]
    end
    
    subgraph "WebSocketé€šä¿¡"
        A -->|ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚| WS[WebSocketã‚µãƒ¼ãƒãƒ¼]
        WS -->|ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ | A
    end
    
    subgraph "ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥"
        PS[ğŸ“¡ Push Service] --> SW
        WS --> PS
        SW --> N
    end
    
    subgraph "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ"
        SW --> C[ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸]
        B --> WS
        C --> B
    end
    
    subgraph "çµ±åˆåˆ¶å¾¡"
        WS --> UC[ğŸ¯ çµ±åˆåˆ¶å¾¡]
        PS --> UC
        UC --> DM[ğŸ“Š é…ä¿¡ç®¡ç†]
        DM --> L[ğŸ“ ãƒ­ã‚°è¨˜éŒ²]
    end
    
    style SW fill:#f3e5f5
    style WS fill:#e8f5e8
    style UC fill:#fff3e0
    style N fill:#e3f2fd
`} />

</Section>

<Section title="å¤§è¦æ¨¡é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ " icon="concept">

<Card title="ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«é€šçŸ¥é…ä¿¡" icon="info" accentColor="amber">

å¤§é‡ã®é€šçŸ¥ã‚’åŠ¹ç‡çš„ã«é…ä¿¡ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚

</Card>

<Mermaid chart={`
graph TB
    subgraph "ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼"
        LB[âš–ï¸ WebSocketãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼]
    end
    
    subgraph "WebSocketã‚µãƒ¼ãƒãƒ¼ç¾¤"
        WS1[WebSocketã‚µãƒ¼ãƒãƒ¼1]
        WS2[WebSocketã‚µãƒ¼ãƒãƒ¼2]
        WS3[WebSocketã‚µãƒ¼ãƒãƒ¼3]
        WS4[WebSocketã‚µãƒ¼ãƒãƒ¼N]
    end
    
    subgraph "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°åŸºç›¤"
        MQ[ğŸ“¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼]
        PS[ğŸ“¤ Pub/Subã‚·ã‚¹ãƒ†ãƒ ]
        BR[ğŸ“Š ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼]
    end
    
    subgraph "é€šçŸ¥å‡¦ç†"
        NE[ğŸ”” é€šçŸ¥ã‚¨ãƒ³ã‚¸ãƒ³ç¾¤]
        FT[ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°]
        RT[ğŸ“Š ãƒ¬ãƒ¼ãƒˆåˆ¶é™]
    end
    
    subgraph "æ°¸ç¶šåŒ–å±¤"
        DB[ğŸ’¾ é€šçŸ¥å±¥æ­´DB]
        CACHE[âš¡ Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥]
        QUEUE[ğŸ“¦ é…å»¶ã‚­ãƒ¥ãƒ¼]
    end
    
    LB --> WS1
    LB --> WS2
    LB --> WS3
    LB --> WS4
    
    WS1 --> PS
    WS2 --> PS
    WS3 --> PS
    WS4 --> PS
    
    PS --> MQ
    MQ --> NE
    NE --> FT
    FT --> RT
    RT --> QUEUE
    
    NE --> CACHE
    RT --> DB
    
    style LB fill:#f3e5f5
    style PS fill:#e8f5e8
    style NE fill:#fff3e0
    style CACHE fill:#e3f2fd
`} />

</Section>

<Section title="é€šçŸ¥åˆ†æãƒ»æœ€é©åŒ–" icon="flow">

<Card title="é…ä¿¡åŠ¹æœæ¸¬å®š" icon="info" accentColor="teal">

é€šçŸ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ¸¬å®šã¨æœ€é©åŒ–ã€‚

</Card>

<Mermaid chart={`
graph LR
    subgraph "é…ä¿¡ãƒ‡ãƒ¼ã‚¿"
        S[ğŸ“¤ é€ä¿¡ãƒ­ã‚°] --> A[ğŸ“Š åˆ†æã‚¨ãƒ³ã‚¸ãƒ³]
        D[ğŸ“¥ é…ä¿¡ãƒ­ã‚°] --> A
        O[ğŸ‘ï¸ é–‹å°ãƒ­ã‚°] --> A
        C[ğŸ‘† ã‚¯ãƒªãƒƒã‚¯ãƒ­ã‚°] --> A
    end
    
    subgraph "åˆ†æå‡¦ç†"
        A --> M[ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—]
        M --> SEG[ğŸ‘¥ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ]
        SEG --> OPT[âš¡ æœ€é©åŒ–ææ¡ˆ]
    end
    
    subgraph "å¯è¦–åŒ–"
        M --> DB[ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰]
        SEG --> RP[ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆ]
        OPT --> AL[ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆ]
    end
    
    subgraph "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—"
        OPT --> TS[â° é…ä¿¡æ™‚é–“æœ€é©åŒ–]
        OPT --> FS[ğŸ¯ ãƒ•ãƒªãƒ¼ã‚±ãƒ³ã‚·ãƒ¼æœ€é©åŒ–]
        OPT --> CS[ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ€é©åŒ–]
    end
    
    style A fill:#f3e5f5
    style M fill:#e8f5e8
    style OPT fill:#fff3e0
    style DB fill:#e3f2fd
`} />

</Section>

<Section title="å®Ÿè£…ä¾‹" icon="code">

<UseCaseExample
  title="é€šçŸ¥è¨­å®šç®¡ç†"
  category="Notification Preferences"
  description="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šçŸ¥è¨­å®šã‚’ç®¡ç†ã—ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒãƒ£ãƒãƒ«ã§é€šçŸ¥ã‚’é…ä¿¡ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚"
  code={preferencesCode}
  language="javascript"
  complexity="intermediate"
  features={[
    "ä¼‘çœ æ™‚é–“è¨­å®š",
    "ãƒ•ãƒªãƒ¼ã‚¯ã‚¨ãƒ³ã‚·ãƒ¼åˆ¶é™",
    "ãƒãƒ£ãƒãƒ«åˆ¥è¨­å®š",
    "WebSocketãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ",
    "ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œ",
    "æŸ”è»Ÿãªè¨­å®šç®¡ç†"
  ]}
/>

<UseCaseExample
  title="é€šçŸ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…"
  category="Rate Limiting"
  description="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒãƒ£ãƒãƒ«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã§ã®é€šçŸ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£…ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã‚’ä¿ã¡ã¾ã™ã€‚"
  code={rateLimiterCode}
  language="javascript"
  complexity="advanced"
  features={[
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™",
    "ãƒãƒ£ãƒãƒ«åˆ¥åˆ¶é™",
    "ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆ¶é™",
    "è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½",
    "WebSocketã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é…ä¿¡",
    "åˆ¶é™è¶…éãƒ­ã‚°"
  ]}
/>

<UseCaseExample
  title="é«˜ä¿¡é ¼æ€§é€šçŸ¥é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ "
  category="Reliable Delivery"
  description="ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã¨ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é…ä¿¡ã‚’å‚™ãˆãŸé«˜ä¿¡é ¼æ€§é€šçŸ¥é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚"
  code={deliveryCode}
  language="javascript"
  complexity="advanced"
  features={[
    "æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ãƒªãƒˆãƒ©ã‚¤",
    "ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é…ä¿¡",
    "WebSocketãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡",
    "Dead Letter Queue",
    "é…ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½è·¡",
    "éšœå®³æ™‚ã®ç®¡ç†è€…é€šçŸ¥"
  ]}
/>

<UseCaseExample
  title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
  category="Metrics & Analytics"
  description="é€šçŸ¥ã®é…ä¿¡çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã—ã€åˆ†æãƒ»æœ€é©åŒ–ã‚’è¡Œã†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚"
  code={metricsCode}
  language="javascript"
  complexity="advanced"
  features={[
    "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹é…ä¿¡",
    "ãƒãƒ£ãƒãƒ«åˆ¥åˆ†æ",
    "é…ä¿¡ç‡ãƒ»é–‹å°ç‡è¨ˆæ¸¬",
    "ã‚¢ãƒ©ãƒ¼ãƒˆé—¾å€¤ç›£è¦–",
    "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ",
    "æœ€é©åŒ–ææ¡ˆ"
  ]}
/>

</Section>

<Section title="ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹" icon="tips">

<Card title="å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ" icon="info" accentColor="blue">

### 1. é€šçŸ¥è¨­å®šç®¡ç†
- **æŸ”è»Ÿãªè¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³**: ç´°ã‹ã„é€šçŸ¥åˆ¶å¾¡
- **ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åœ°åŸŸã«å¿œã˜ãŸé…ä¿¡
- **ãƒãƒ£ãƒãƒ«åˆ¥è¨­å®š**: é…ä¿¡ãƒãƒ£ãƒãƒ«ã®å€‹åˆ¥åˆ¶å¾¡

### 2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
- **å¤šå±¤åˆ¶é™**: ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒãƒ£ãƒãƒ«/ã‚°ãƒ­ãƒ¼ãƒãƒ«
- **å‹•çš„èª¿æ•´**: è² è·ã«å¿œã˜ãŸåˆ¶é™å€¤å¤‰æ›´
- **å…¬å¹³æ€§**: ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã®å…¬å¹³ãªãƒªã‚½ãƒ¼ã‚¹é…åˆ†

### 3. é…ä¿¡ä¿è¨¼æ©Ÿèƒ½
- **ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
- **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼**: ä»£æ›¿ãƒãƒ£ãƒãƒ«ã®ä½¿ç”¨
- **Dead Letter Queue**: å¤±æ•—é€šçŸ¥ã®ç®¡ç†

### 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- **ãƒ©ã‚¤ãƒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: WebSocketãƒ™ãƒ¼ã‚¹
- **ã‚¢ãƒ©ãƒ¼ãƒˆé—¾å€¤**: ç•°å¸¸ã®æ—©æœŸæ¤œçŸ¥
- **ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ**: é…ä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æŠŠæ¡

### 5. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …
- **æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: WebSocketã‚µãƒ¼ãƒãƒ¼ã®åˆ†æ•£
- **ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°**: ãƒãƒ¼ã‚¹ãƒˆãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¯¾ç­–
- **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**: é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é«˜é€ŸåŒ–

ã“ã®åŒ…æ‹¬çš„ãªé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€é«˜å¯ç”¨æ€§ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªé€šçŸ¥é…ä¿¡ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

</Card>

</Section>

</ReferenceLayout>